ğŸ› ï¸ Documento TÃ©cnico: AtualizaÃ§Ã£o Massiva de Servidores ESXi via Ansible
Autor: Eng. SÃªnior DevOps
Data: 11/06/2025
VersÃ£o: 1.0
Ambiente: VMware vSphere ESXi 7/8
Ferramenta: Ansible

ğŸ“‹ Objetivo
Automatizar o processo de atualizaÃ§Ã£o de mÃºltiplos servidores VMware ESXi utilizando Ansible, reduzindo riscos de falhas manuais e garantindo consistÃªncia entre os hosts.

ğŸ§± Requisitos
Ansible Controller
Ansible 2.10+ instalado

Acesso Ã  rede dos hosts ESXi

DiretÃ³rio de projeto com os arquivos necessÃ¡rios

Hosts ESXi
Acesso SSH habilitado temporariamente

Shell habilitado

SCP habilitado

UsuÃ¡rio com permissÃµes de root

Datastore acessÃ­vel (/vmfs/volumes/datastore1)

Patch Bundle
Arquivo .zip do tipo offline bundle

Exemplo: VMware-ESXi-8.0.1-XXXXXX-depot.zip

ğŸ—‚ï¸ Estrutura do Projeto
esxi_update_ansible/
â”œâ”€â”€ hosts                      # InventÃ¡rio Ansible
â”œâ”€â”€ playbook.yml               # Playbook principal
â””â”€â”€ files/
    â””â”€â”€ VMware-ESXi-8.0.1-XXXXXX-depot.zip   # Patch ESXi
ğŸ§¾ InventÃ¡rio (hosts)
ini
Copiar
Editar
[esxi_hosts]
esxi-host01 ansible_host=192.168.1.101
esxi-host02 ansible_host=192.168.1.102
esxi-host03 ansible_host=192.168.1.103

[esxi_hosts:vars]
ansible_user=root
ansible_password=SuaSenhaAqui
ansible_connection=ssh
ansible_ssh_common_args='-o StrictHostKeyChecking=no'
â–¶ï¸ Playbook (playbook.yml)
Resumo das etapas realizadas:

Habilita SSH no host.

Cria diretÃ³rio para update.

Copia o patch para o host.

Executa esxcli software vib update.

Reinicia o host.

Aguarda o host voltar (checa via SSH).

Desabilita SSH (opcional).

ğŸ’» ExecuÃ§Ã£o
Para iniciar o processo de atualizaÃ§Ã£o, execute:

bash
Copiar
Editar
ansible-playbook -i hosts playbook.yml
Recomenda-se executar primeiro em um host de homologaÃ§Ã£o.

ğŸ“Œ ConsideraÃ§Ãµes Importantes
Backup obrigatÃ³rio das VMs ou snapshots antes de aplicar o patch.

SSH deve estar habilitado previamente ou via PowerCLI/API.

O processo reinicia os hosts â€” garanta que as VMs estejam migradas ou desligadas.

Use junto com vCenter DRS ou scripts que coloquem o host em modo de manutenÃ§Ã£o.

Testado em ESXi 7.0U3 e ESXi 8.0.1.

ğŸ“¤ Logs e Auditoria
Os logs da execuÃ§Ã£o do playbook podem ser salvos com:

bash
Copiar
Editar
ansible-playbook -i hosts playbook.yml | tee update-log-$(date +%F).log
ğŸ“ Anexos
 Patch: files/VMware-ESXi-8.0.1-XXXXXX-depot.zip

 Arquivo de inventÃ¡rio: hosts

 Playbook Ansible: playbook.yml

ğŸ“ Suporte
Em caso de falhas ou dÃºvidas:

Slack: #infraestrutura-devops

Email: devops@empresa.com

DocumentaÃ§Ã£o VMware: https://kb.vmware.com
